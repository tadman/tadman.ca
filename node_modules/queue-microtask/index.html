<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>queue-microtask [![ci][ci-image]][ci-url] [![npm][npm-image]][npm-url] [![downloads][downloads-image]][downloads-url] [![javascript style guide][standard-image]][standard-url]</title>
    <link rel="stylesheet" media="all" href="/assets/css/main.css"/>
  </head>
  <body class="bg-blue-900 p-8">
    <h1 id="queue-microtask----">queue-microtask <a href="https://github.com/feross/queue-microtask/actions"><img src="https://img.shields.io/github/workflow/status/feross/queue-microtask/ci/master" alt="ci" /></a> <a href="https://npmjs.org/package/queue-microtask"><img src="https://img.shields.io/npm/v/queue-microtask.svg" alt="npm" /></a> <a href="https://npmjs.org/package/queue-microtask"><img src="https://img.shields.io/npm/dm/queue-microtask.svg" alt="downloads" /></a> <a href="https://standardjs.com"><img src="https://img.shields.io/badge/code_style-standard-brightgreen.svg" alt="javascript style guide" /></a></h1>

<h3 id="fast-tiny-queuemicrotask-shim-for-modern-engines">fast, tiny <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/queueMicrotask"><code class="language-plaintext highlighter-rouge">queueMicrotask</code></a> shim for modern engines</h3>

<ul>
  <li>Use <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/queueMicrotask"><code class="language-plaintext highlighter-rouge">queueMicrotask</code></a> in all modern JS engines.</li>
  <li>No dependencies. Less than 10 lines. No shims or complicated fallbacks.</li>
  <li>Optimal performance in all modern environments
    <ul>
      <li>Uses <code class="language-plaintext highlighter-rouge">queueMicrotask</code> in modern environments</li>
      <li>Fallback to <code class="language-plaintext highlighter-rouge">Promise.resolve().then(fn)</code> in Node.js 10 and earlier, and old browsers (same performance as <code class="language-plaintext highlighter-rouge">queueMicrotask</code>)</li>
    </ul>
  </li>
</ul>

<h2 id="install">install</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install queue-microtask
</code></pre></div></div>

<h2 id="usage">usage</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">queueMicrotask</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">queue-microtask</span><span class="dl">'</span><span class="p">)</span>

<span class="nx">queueMicrotask</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="cm">/* this will run soon */</span> <span class="p">})</span>
</code></pre></div></div>

<h2 id="what-is-queuemicrotask-and-why-would-one-use-it">What is <code class="language-plaintext highlighter-rouge">queueMicrotask</code> and why would one use it?</h2>

<p>The <code class="language-plaintext highlighter-rouge">queueMicrotask</code> function is a WHATWG standard. It queues a microtask to be executed prior to control returning to the event loop.</p>

<p>A microtask is a short function which will run after the current task has completed its work and when there is no other code waiting to be run before control of the execution context is returned to the event loop.</p>

<p>The code <code class="language-plaintext highlighter-rouge">queueMicrotask(fn)</code> is equivalent to the code <code class="language-plaintext highlighter-rouge">Promise.resolve().then(fn)</code>. It is also very similar to <a href="https://nodejs.org/api/process.html#process_process_nexttick_callback_args"><code class="language-plaintext highlighter-rouge">process.nextTick(fn)</code></a> in Node.</p>

<p>Using microtasks lets code run without interfering with any other, potentially higher priority, code that is pending, but before the JS engine regains control over the execution context.</p>

<p>See the <a href="https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#microtask-queuing">spec</a> or <a href="https://nodejs.org/api/globals.html#globals_queuemicrotask_callback">Node documentation</a> for more information.</p>

<h2 id="who-is-this-package-for">Who is this package for?</h2>

<p>This package allows you to use <code class="language-plaintext highlighter-rouge">queueMicrotask</code> safely in all modern JS engines. Use it if you prioritize small JS bundle size over support for old browsers.</p>

<p>If you just need to support Node 12 and later, use <code class="language-plaintext highlighter-rouge">queueMicrotask</code> directly. If you need to support all versions of Node, use this package.</p>

<h2 id="why-not-use-processnexttick">Why not use <code class="language-plaintext highlighter-rouge">process.nextTick</code>?</h2>

<p>In Node, <code class="language-plaintext highlighter-rouge">queueMicrotask</code> and <code class="language-plaintext highlighter-rouge">process.nextTick</code> are <a href="https://nodejs.org/api/globals.html#globals_queuemicrotask_callback">essentially equivalent</a>, though there are <a href="https://github.com/YuzuJS/setImmediate#macrotasks-and-microtasks">subtle differences</a> that don’t matter in most situations.</p>

<p>You can think of <code class="language-plaintext highlighter-rouge">queueMicrotask</code> as a standardized version of <code class="language-plaintext highlighter-rouge">process.nextTick</code> that works in the browser. No need to rely on your browser bundler to shim <code class="language-plaintext highlighter-rouge">process</code> for the browser environment.</p>

<h2 id="why-not-use-settimeoutfn-0">Why not use <code class="language-plaintext highlighter-rouge">setTimeout(fn, 0)</code>?</h2>

<p>This approach is the most compatible, but it has problems. Modern browsers throttle timers severely, so <code class="language-plaintext highlighter-rouge">setTimeout(…, 0)</code> usually takes at least 4ms to run. Furthermore, the throttling gets even worse if the page is backgrounded. If you have many <code class="language-plaintext highlighter-rouge">setTimeout</code> calls, then this can severely limit the performance of your program.</p>

<h2 id="why-not-use-a-microtask-library-like-immediate-or-asap">Why not use a microtask library like <a href="https://www.npmjs.com/package/immediate"><code class="language-plaintext highlighter-rouge">immediate</code></a> or <a href="https://www.npmjs.com/package/asap"><code class="language-plaintext highlighter-rouge">asap</code></a>?</h2>

<p>These packages are great! However, if you prioritize small JS bundle size over optimal performance in old browsers then you may want to consider this package.</p>

<p>This package (<code class="language-plaintext highlighter-rouge">queue-microtask</code>) is four times smaller than <code class="language-plaintext highlighter-rouge">immediate</code>, twice as small as <code class="language-plaintext highlighter-rouge">asap</code>, and twice as small as using <code class="language-plaintext highlighter-rouge">process.nextTick</code> and letting the browser bundler shim it automatically.</p>

<p>Note: This package throws an exception in JS environments which lack <code class="language-plaintext highlighter-rouge">Promise</code> support – which are usually very old browsers and Node.js versions.</p>

<p>Since the <code class="language-plaintext highlighter-rouge">queueMicrotask</code> API is supported in Node.js, Chrome, Firefox, Safari, Opera, and Edge, <strong>the vast majority of users will get optimal performance</strong>. Any JS environment with <code class="language-plaintext highlighter-rouge">Promise</code>, which is almost all of them, also get optimal performance. If you need support for JS environments which lack <code class="language-plaintext highlighter-rouge">Promise</code> support, use one of the alternative packages.</p>

<h2 id="what-is-a-shim">What is a shim?</h2>

<blockquote>
  <p>In computer programming, a shim is a library that transparently intercepts API calls and changes the arguments passed, handles the operation itself or redirects the operation elsewhere. – <a href="https://en.wikipedia.org/wiki/Shim_(computing)">Wikipedia</a></p>
</blockquote>

<p>This package could also be described as a “ponyfill”.</p>

<blockquote>
  <p>A ponyfill is almost the same as a polyfill, but not quite. Instead of patching functionality for older browsers, a ponyfill provides that functionality as a standalone module you can use. – <a href="https://ponyfoo.com/articles/polyfills-or-ponyfills">PonyFoo</a></p>
</blockquote>

<h2 id="api">API</h2>

<h3 id="queuemicrotaskfn"><code class="language-plaintext highlighter-rouge">queueMicrotask(fn)</code></h3>

<p>The <code class="language-plaintext highlighter-rouge">queueMicrotask()</code> method queues a microtask.</p>

<p>The <code class="language-plaintext highlighter-rouge">fn</code> argument is a function to be executed after all pending tasks have completed but before yielding control to the browser’s event loop.</p>

<h2 id="license">license</h2>

<p>MIT. Copyright (c) <a href="https://feross.org">Feross Aboukhadijeh</a>.</p>

  </body>
</html>
